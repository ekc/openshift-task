# OpenShift Tasks

** Work in progress **

## CLI

### how to get oc command line help

`oc <command> --help`

### How to get more information about OpenShift object

`oc explain <object>`

for example:

`oc explain pod`
`oc explain --recursive`
	
### how to enable oc command line completion
```
oc completion bash > oc_completion.sh
source oc_completion.sh
```

Use tab oc command, you will get command line completion.

### How to install oc tool

In Web Console, click **?** button -> **Command Line Tools** -> **oc \- OpenShift Command Line Interface (CLI)**
unpack and copy `oc` binary to **/usr/local/bin**

## CLI Access

### 0. how to find OpenShift API Server URL.

Login to Web Console and click at **Username** for example: **kube-admin** button on top right -> Copy Login Command -> Display Token

Example:

https://api.cluster-1563.1563.sandbox283.opentlc.com:6443

### 1. How to login using username password to the cluser using oc CLI tool.

`oc login -u username -p passw0rd https://api.cluster-1563.1563.sandbox283.opentlc.com:6443`

### 2. How to su -

If you have enough permissions to impersonate, obviously. You only need to use the flag --as.

For example:

run the command as bank user

`oc --as=bank get pods`

run the command as system:admin user from regular user.

`oc --as=system:admin get secret -n openshift-config`

Also, a group impersonation can be done, instead of a user impersonation:

`oc --as-group=developers get pods`

This is helpful in switching between users and can be used to test user/group permission.

### 3. How to imposonate system:admin

`oc --as=system:admin <command>`

### 4. How access cluster using TLS certificate (X.590)

`export KUBECONFIG=/home/user/auth/kubeconfig` </p>
`oc <command>`

or

`oc <command> --kubeconfig /home/user/auth/kubeconfig`


### 5. How to login using token.

`oc login --token <token>`

## Users / Groups

### 1. How to add user accounts from htpasswd

The HTPasswd identity provider validates users against a secret that that contains user names and passwords generated with the htpasswd command from the Apache HTTP Server project. Only a cluster administrator is allowed to change the data inside the secret. Regular users cannot change their own passwords.


1.1 create htpasswd file </p>

`htpasswd -c -B -b </path/to/users.htpasswd> <user_name> <password> `. </p>

Example </p>

`htpasswd -c -B -b users.htpasswd user1 MyPassword!`

continue to add user </p>

`htpasswd -B -b </path/to/users.htpasswd> <user_name> <password>`

delete user </p>

`htpasswd -D /tmp/htpasswd student`

1.2 create htpasswd file secret in openshift-config project.

`oc create secret generic htpass-secret --from-file=htpasswd=</path/to/users.htpasswd> -n openshift-config`

1.3 create custom resource definition for htpasswd identity provider.

```
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: my_htpasswd_provider 
    mappingMethod: claim 
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpasswd
```
1.4 Apply resource definition to openshift

`oc apply -f </path/to/CR>`

* user needs to login to the cluster before it appears in `oc get users`

### 2. How to update user/password in htpasswd

2.1 Add more user </p>

`htpasswd -B -b </path/to/users.htpasswd> <user_name> <password>`

2.2 Update htpasswd secret

`oc create secret generic htpasswd --from-file=htpasswd=htpasswd --dry-run -o yaml -n openshift-config | oc replace -f -`

### 3. how to delete htpasswd user

3.1 delete user </p>

`htpasswd -D /tmp/htpasswd student`

3.2 update htpasswd secret

`oc create secret generic htpass-secret --from-file=htpasswd=users.htpasswd --dry-run -o yaml -n openshift-config | oc replace -f -`

3.3 if you delete user from identity provider, the user and identity resources must be removed as well.

```
oc delete user <username>
oc get identities | grep <username>
oc delete identity my_htpasswd_provider:<username>
oc delete identity <username>
```

### 4. How to extract secret data
`
 oc extract secret/htpasswd -n openshift-config --to - > /tmp/htpasswd`

### 5. How to remove kubeadmin user

After an installation has completed, OpenShift creates the kubeadmin virtual user. There are no user or identity resources for that virtual user. The kubeadmin user is hard-coded as a cluster administrator and you cannot change its privileges. It is also hard-coded to authenticate using the password stored in kubeadmin, from the kube-system project.
The kubeadmin password is dynamically generated by the installer and completely unique to your environment. The installation logs provide kubeadmin credentials used to log in to the cluster. The cluster installation logs also provide log in, password, and the URL for console access.

After you define an identity provider, create a new user, and assign that user the cluster-admin role, you can remove the kubeadmin user credentials to improve cluster security.

`oc delete secret kubeadmin -n kube-system`

**Warning**
If you delete the kubeadmin secret before you configure another user with cluster admin privileges, the only way you can administer your cluster would be using the kubeconfig file. If you do not have a copy of this file in a safe location, then there is no way to recover administrative access to your cluster. The only alternative is destroying and reinstalling your cluster.

### 6. How to create group

6.1 create new group

`oc adm groups new developer`

6.2 add user to group

`oc adm groups add-users developer clair`

6.3 view group information

```
$ oc get groups
NAME        USERS
developer   clair, dick
```

6.4 remove user from group

`oc adm groups remove-users developer clair`

### 7. How to create service accounts.

`oc create sa <service_account_name> `

## Service Accounts


## RBAC

Default cluster roles


**Admin**
A project manager. If used in a local binding, an admin has rights to view any resource in the project and modify any resource in the project except for quota.

**basic-user**
A user that can get basic information about projects and users.

**cluster-admin** A super-user that can perform any action in any project. When bound to a user with a local binding, they have full control over quota and every action on every resource in the project.

**cluster-status** A user that can get basic cluster status information.

**edit** A user that can modify most objects in a project but does not have the power to view or modify roles or bindings.

**self-provisioner** A user that can create their own projects.

**view** A user who cannot make any modifications, but can see most objects in a project. They cannot view or modify roles or bindings.

### 1. How to assign cluster administrative privileges (cluster-admin) to user.
```
$ oc adm policy add-cluster-role-to-user cluster-admin keith
clusterrole.rbac.authorization.k8s.io/cluster-admin added: "keith"

$ oc get clusterrolebindings cluster-admin-0 -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: "2020-08-21T03:17:09Z"
  name: cluster-admin-0
  resourceVersion: "590469"
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin-0
  uid: 66ad0ced-b094-4eee-8ca0-3bfccf123a2b
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: keith
  
```

### 2. How to create developer user or user group (edit role)

`oc policy add-role-to-user edit <username> -n project-name (optional)`

`oc policy add-role-to-group edit dev-group` </p>


### 3. How to assign sudoer cluster role to user.

`oc create clusterrolebinding <any_valid_name> --clusterrole=sudoer --user=<username>`

Example:

```
$ oc create clusterrolebinding bank-as-sudoer --clusterrole=sudoer --user=bank
clusterrolebinding.rbac.authorization.k8s.io/bank-as-sudoer created

$ oc get clusterrolebinding.rbac.authorization.k8s.io/bank-as-sudoer -o yaml

$ oc --as=system:admin whoami
system:admin

$ oc get secret -n openshift-config
Error from server (Forbidden): secrets is forbidden: User "bank" cannot list resource "secrets" in API group "" in the namespace "openshift-config"

$ oc --as=system:admin get secret -n openshift-config
NAME                                  TYPE                                  DATA   AGE
builder-dockercfg-2df5d               kubernetes.io/dockercfg               1      3d14h
builder-token-2g5pk                   kubernetes.io/service-account-token   4      3d14h
builder-token-8p2p7                   kubernetes.io/service-account-token   4      3d14h
default-dockercfg-nbg7w               kubernetes.io/dockercfg               1      3d14h
default-token-drwtv                   kubernetes.io/service-account-token   4      3d14h
default-token-jfx72                   kubernetes.io/service-account-token   4      3d14h
deployer-dockercfg-km5n4              kubernetes.io/dockercfg               1      3d14h
deployer-token-pnx8s                  kubernetes.io/service-account-token   4      3d14h
deployer-token-vm7p7                  kubernetes.io/service-account-token   4      3d14h
etcd-client                           SecretTypeTLS                         2      3d14h
etcd-metric-client                    SecretTypeTLS                         2      3d14h
etcd-metric-signer                    SecretTypeTLS                         2      3d14h
etcd-signer                           SecretTypeTLS                         2      3d14h
htpasswd                              Opaque                                1      3d10h
initial-service-account-private-key   Opaque                                1      3d14h
pull-secret                           kubernetes.io/dockerconfigjson        1      3d14h

```
### 4. How to remove self-provisioner role from authenticated user:

` oc adm policy remove-cluster-role-from-group self-provisioner system:authenticated:oauth`
 
 
### 5. How to assign project admin privilege to user "keith"

`oc adm policy add-role-to-user admin keith -n project-name`

### 6. How to assign read-only permission to user "keith"

`oc adm policy add-role-to-user view keith -n project-name`

### 7. How to assign full control over the project including rate limit. 

`oc adm policy add-role-to-user cluster-admin keith -n <project-name>`


### 8. How to test which user can perform tasks.

`oc adm policy who-can delete user`

## Projects


### 1. How to create openshift project

```
oc new-project hello-openshift \
    --description="This is an example project" \
    --display-name="Hello OpenShift"
```
    
### 2. How to switch between project.

`oc project <project_name>`

### 3. How to delete project

`oc delete project <project_name>`

### 4. how to allow other user to work on my project

`oc policy add-role-to-group edit <username> -n project-name (optional)`


## Build

### 1. How to create build config from local git repository

`oc new-build .`

### 2. How to create a build config from remote git repository

`oc new-build https://github.com/sclorg/cakephp-ex`

### 3. How to start build from specified build config

`oc start-build python`

### 4. How to start build from previous build

`oc start-build --from-build=python-1`

## Application

### 1. How to deploy new application from Source code

oc new-app /<path to source code>
oc new-app https://github.com/sclorg/cakephp-ex
oc new-app https://github.com/youruser/yourprivaterepo --source-secret=yoursecret

### 2. How to deploy new application from Dockerfile

oc new-app https://github.com/thanachit/my-simple-web

*given that there is Dockerfile in my repository.

### 3. How to deploy new application from Docker Image on dockerhub.

```
oc new-app mysql
```

or Existing image stream:

```
oc new-app my-stream:v1
```

### How to remove all resources related to Application

```
$ oc delete all -l app=hello-openshift
pod "example-75778c488-9nz95" deleted
pod "example-75778c488-h7n9g" deleted
pod "example-75778c488-pd6rw" deleted
replicaset.apps "example-75778c488" deleted
```

## Image & Image Stream & Image Stream Tag

Containers, images, and imagestreams are important concepts to understand when you set out to create and manage containerized software. An image holds a set of software that is ready to run, while a container is a running instance of a container image. An imagestream provides a way of storing different versions of the same basic image. Those different versions are represented by different tags on the same image name.


An imagestream and its associated tags provide an abstraction for referencing container images from within OpenShift Container Platform. The imagestream and its tags allow you to see what images are available and ensure that you are using the specific image you need even if the image in the repository changes.

Imagestreams do not contain actual image data, but present a single virtual view of related images, similar to an image repository.

You can configure Builds and Deployments to watch an imagestream for notifications when new images are added and react by performing a Build or Deployment, respectively.


More information: https://docs.openshift.com/container-platform/4.5/openshift_images/images-understand.html#images-about_images-understand

### How to import image to OpenShift Internal registry.

```
$ oc import-image nginx:latest --confirm
imagestream.image.openshift.io/nginx imported

Name:			nginx
Namespace:		default
Created:		Less than a second ago
Labels:			<none>
Annotations:		openshift.io/image.dockerRepositoryCheck=2020-08-21T13:29:14Z
Image Repository:	image-registry.openshift-image-registry.svc:5000/default/nginx
Image Lookup:		local=false
Unique Images:		1
Tags:			1

latest
  tagged from nginx:latest

  * nginx@sha256:179412c42fe3336e7cdc253ad4a2e03d32f50e3037a860cf5edbeb1aaddb915c
      Less than a second ago

Image Name:	nginx:latest
Docker Image:	nginx@sha256:179412c42fe3336e7cdc253ad4a2e03d32f50e3037a860cf5edbeb1aaddb915c
Name:		sha256:179412c42fe3336e7cdc253ad4a2e03d32f50e3037a860cf5edbeb1aaddb915c
Created:	Less than a second ago
Annotations:	image.openshift.io/dockerLayersOrder=ascending
Image Size:	53.5MB in 5 layers
Layers:		27.09MB	sha256:bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb
		26.4MB	sha256:cb9a6de05e5a22241e25960c7914f11b56c9070ce28b8f69e899236e0d265c50
		600B	sha256:9513ea0afb9372e5cabc4070c7adda0e8fc4728e0ad362b349fe233480f2e7d8
		899B	sha256:b49ea07d2e9310b387436861db613a0a26a98855372e9d5e207660b0de7975a7
		666B	sha256:a5e4a503d449887a0be28a2969149e647460aa6013f9ca90e88491aedf84f24e
Image Created:	7 days ago
Author:		<none>
Arch:		amd64
Entrypoint:	/docker-entrypoint.sh
Command:	nginx -g daemon off;
Working Dir:	<none>
User:		<none>
Exposes Ports:	80/tcp
Docker Labels:	maintainer=NGINX Docker Maintainers <docker-maint@nginx.com>
Environment:	PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
		NGINX_VERSION=1.19.2
		NJS_VERSION=0.4.3
		PKG_RELEASE=1~buster
```

### How to tag image

OpenShift Container Platform provides the oc tag command, which is similar to the docker tag command, but operates on imagestreams instead of directly on images.

`oc tag nginx:latest nginx:stable	`


There are different types of tags available. The default behavior uses a permanent tag, which points to a specific image in time. If the _permanent tag_ is in use and the source changes, the tag does not change for the destination.

A _tracking tag_ means the destination tag’s metadata is updated during the import of the source tag.

To ensure the destination tag is updated whenever the source tag changes, use the --alias=true flag:

`$ oc tag --alias=true <source> <destination>`

 	
Note: Use a tracking tag for creating permanent aliases, for example, latest or stable. The tag only works correctly within a single imagestream. Trying to create a cross-imagestream alias produces an error.


You can also add the --scheduled=true flag to have the destination tag be refreshed, or re-imported, periodically. The period is configured globally at the system level.

The --reference flag creates an imagestreamtag that is not imported. The tag points to the source location, permanently

More info: https://docs.openshift.com/container-platform/4.5/openshift_images/managing_images/tagging-images.html

### Configuring periodic importing of imagestreamtags

```
oc tag <repositiory/image> <image-name:tag> --scheduled
```

Example:

```
oc tag docker.io/python:3.6.0 python:3.6 --scheduled

Tag python:3.6 set to import docker.io/python:3.6.0 periodically.
```

This command causes OpenShift Container Platform to periodically update this particular image stream tag. This period is a cluster-wide setting set to 15 minutes by default.

Remove the periodic check, re-run above command but omit the --scheduled flag. This will reset its behavior to default.

`oc tag <repositiory/image> <image-name:tag>`

https://docs.openshift.com/container-platform/4.5/openshift_images/image-streams-manage.html

### How to allow pod to reference images from different project

https://docs.openshift.com/container-platform/4.5/openshift_images/managing_images/using-image-pull-secrets.html

### What is the guideline for creating image

https://docs.openshift.com/container-platform/4.5/openshift_images/create-images.html

### How to refer to imagestream in Deployment

```oc set triggers deployment/myapp --from-image ubi:8 -c myapp```

https://developers.redhat.com/blog/2019/09/20/using-red-hat-openshift-image-streams-with-kubernetes-deployments/

## Resource Management
1. limit resource usage

## Upgrade
1. How to upgrade OpenShift Cluster
## Scale
1. scale application to meet increased demand

## Event & Alert & logs

1. HOw to monitor cluster status
2. How to monitor cluster event and alerts
3. How to view logs 
4. How to view log of failed/terminated pods.
5. 
## Kubernetes Resources
1. How to import Kubernetes resources


## Networking - Routes, Services, Ingress
1. How to create route (Expose a Service externally as a Route)

Example: Expose a Service

`$ oc expose service/parksmap-katacoda`

Example: Expose a Service and specify the host name

`$ oc expose service/parksmap-katacoda --hostname=www.my-host.com`


2. How to remove route
3. Create self signed certificate
4. Secure route using TLS certificate

## Rollout

## Cluster Scaling.

## Installation

## Troubleshooting 

### 0. get cluster version
```
oc get clusterversion </p>
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS </p>
version   4.4.8     True        False         3d13h   Cluster version is 4.4.8
```

`oc describe clusterversion`

### review cluster operators status
`oc get clusteroperators`


### debug pod commands
`oc logs pod/podname` </p>
`oc debug pod/podname`

### debug node commands
`oc get nodes` </p>
`oc adm top nodes` </p>
`oc describe node my-node-name` </p>
`oc adm node-logs -u crio my-node-name` </p>
`oc adm node-logs -u kubelet my-node-name` </p>
`oc adm node-logs my-node-name` </p>

open shell prompt to node:

`oc debug node/my-node-name`

> $ oc debug node/ip-10-0-138-229.ap-southeast-1.compute.internal
> 
> Starting pod/ip-10-0-138-229ap-southeast-1computeinternal-debug ...
> To use host binaries, run `chroot /host`
> 
> chroot /host
> Pod IP: 10.0.138.229
> If you don't see a command prompt, try pressing enter.
> 
> sh-4.2# chroot /host </p>
> sh-4.4# cat /etc/*release*
> 
> NAME="Red Hat Enterprise Linux CoreOS"
> 
> VERSION="44.81.202006080130-0"
> 
> VERSION_ID="4.4"
> 
> OPENSHIFT_VERSION="4.4"
> 
> RHEL_VERSION="8.2"
> 
> PRETTY_NAME="Red Hat Enterprise Linux CoreOS 44.81.202006080130-0 (Ootpa)"
> 
> ID="rhcos"
> 

list container on nodes </P>
`crictl ps`

`systemctl status kubelet`

```
$ oc adm top node
NAME                                              CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
ip-10-0-138-229.ap-southeast-1.compute.internal   330m         4%     2541Mi          8%
ip-10-0-152-138.ap-southeast-1.compute.internal   509m         14%    3258Mi          22%
ip-10-0-179-0.ap-southeast-1.compute.internal     421m         5%     3373Mi          11%
ip-10-0-189-168.ap-southeast-1.compute.internal   508m         14%    3221Mi          22%
ip-10-0-214-156.ap-southeast-1.compute.internal   626m         17%    3606Mi          24%
thanachit@BankMBP ~/Projects/openshift-task/users (master)
	
$ oc adm top pod
NAME                      CPU(cores)   MEMORY(bytes)
example-75778c488-9nz95   0m           1Mi
example-75778c488-h7n9g   0m           1Mi
example-75778c488-pd6rw   0m           2Mi
my-simple-web-9-68xr7     0m           28Mi
my-simple-web-9-7n6bp     0m           20Mi
```

### 3. oc with debug

`oc --loglevel 7 get pod`

## Persistent Storage 

