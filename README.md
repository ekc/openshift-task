# OpenShift Tasks

## CLI

	1. oc 
	2. oc command --help
	3. oc explain <object>
	4. oc completion


## CLI Access

### 0. how to find API URL.

Login to Web Console and click at User button on top right -> Copy Login Command -> Display Token

Example:

https://api.cluster-1563.1563.sandbox283.opentlc.com:6443

### 1. How to login using username password to the cluser using oc

`oc login -u username -p passw0rd https://api.cluster-1563.1563.sandbox283.opentlc.com:6443`

### 2. How to su -

If you have enough permissions to impersonate, obviously. You only need to use the flag --as.

For example:

run the command as bank user

`oc --as=bank get pods`

Also, a group impersonation can be done, instead of a user impersonation:

`oc --as-group=developers get pods`

### 3. How to imposonate system:admin

`oc --as=system:admin <command>`

### 4. How access cluster using TLS certificate (X.590)

`export KUBECONFIG=/home/user/auth/kubeconfig` </p>
`oc <command>`

or

`oc <command> --kubeconfig /home/user/auth/kubeconfig`


### 5. How to login using token.

`oc login --token <token>`

## Users / Groups

### 1. How to add user accounts from htpasswd

The HTPasswd identity provider validates users against a secret that that contains user names and passwords generated with the htpasswd command from the Apache HTTP Server project. Only a cluster administrator is allowed to change the data inside the secret. Regular users cannot change their own passwords.


1.1 create htpasswd file </p>

`htpasswd -c -B -b </path/to/users.htpasswd> <user_name> <password> `. </p>

Example </p>

`htpasswd -c -B -b users.htpasswd user1 MyPassword!`

continue to add user </p>

`htpasswd -B -b </path/to/users.htpasswd> <user_name> <password>`

delete user </p>

`htpasswd -D /tmp/htpasswd student`

1.2 create htpasswd file secret in openshift-config project.

`oc create secret generic htpass-secret --from-file=htpasswd=</path/to/users.htpasswd> -n openshift-config`

1.3 create custom resource definition for htpasswd identity provider.

```
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: my_htpasswd_provider 
    mappingMethod: claim 
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpasswd
```
1.4 Apply resource definition to openshift

`oc apply -f </path/to/CR>`

* user needs to login to the cluster before it appears in `oc get users`

### 2. How to update user/password in htpasswd

2.1 Add more user </p>

`htpasswd -B -b </path/to/users.htpasswd> <user_name> <password>`

2.2 Update htpasswd secret

`oc create secret generic htpasswd --from-file=htpasswd=htpasswd --dry-run -o yaml -n openshift-config | oc replace -f -`

### 3. how to delete htpasswd user

3.1 delete user </p>

`htpasswd -D /tmp/htpasswd student`

3.2 update htpasswd secret

`oc create secret generic htpass-secret --from-file=htpasswd=users.htpasswd --dry-run -o yaml -n openshift-config | oc replace -f -`

3.3 if you delete user from identity provider, the user and identity resources must be removed as well.

```
oc delete user <username>
oc get identities | grep <username>
oc delete identity my_htpasswd_provider:<username>
oc delete identity <username>
```

### 4. How to extract secret data
`
 oc extract secret/htpasswd -n openshift-config --to - > /tmp/htpasswd`

### 5. How to remove kubeadmin user

After an installation has completed, OpenShift creates the kubeadmin virtual user. There are no user or identity resources for that virtual user. The kubeadmin user is hard-coded as a cluster administrator and you cannot change its privileges. It is also hard-coded to authenticate using the password stored in kubeadmin, from the kube-system project.
The kubeadmin password is dynamically generated by the installer and completely unique to your environment. The installation logs provide kubeadmin credentials used to log in to the cluster. The cluster installation logs also provide log in, password, and the URL for console access.

After you define an identity provider, create a new user, and assign that user the cluster-admin role, you can remove the kubeadmin user credentials to improve cluster security.

`oc delete secret kubeadmin -n kube-system`

**Warning**
If you delete the kubeadmin secret before you configure another user with cluster admin privileges, the only way you can administer your cluster would be using the kubeconfig file. If you do not have a copy of this file in a safe location, then there is no way to recover administrative access to your cluster. The only alternative is destroying and reinstalling your cluster.

### 6. How to create group

6.1 create new group

`oc adm groups new developer`

6.2 add user to group

`oc adm groups add-users developer clair`

6.3 view group information

```
$ oc get groups
NAME        USERS
developer   clair, dick
```

6.4 remove user from group

`oc adm groups remove-users developer clair`

### 7. How to create service accounts.

`oc create sa <service_account_name> `

## Service Accounts


## RBAC

Default cluster roles


**Admin**
A project manager. If used in a local binding, an admin has rights to view any resource in the project and modify any resource in the project except for quota.

**basic-user**
A user that can get basic information about projects and users.

**cluster-admin** A super-user that can perform any action in any project. When bound to a user with a local binding, they have full control over quota and every action on every resource in the project.

**cluster-status** A user that can get basic cluster status information.

**edit** A user that can modify most objects in a project but does not have the power to view or modify roles or bindings.

**self-provisioner** A user that can create their own projects.

**view** A user who cannot make any modifications, but can see most objects in a project. They cannot view or modify roles or bindings.

### 1. How to assign cluster administrative privileges (cluster-admin) to user.
```
$ oc adm policy add-cluster-role-to-user cluster-admin keith
clusterrole.rbac.authorization.k8s.io/cluster-admin added: "keith"

$ oc get clusterrolebindings cluster-admin-0 -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: "2020-08-21T03:17:09Z"
  name: cluster-admin-0
  resourceVersion: "590469"
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin-0
  uid: 66ad0ced-b094-4eee-8ca0-3bfccf123a2b
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: keith
  
```

### 2. How to create developer user or user group (edit role)

`oc policy add-role-to-group edit dev-group` </p>
`oc policy add-role-to-user edit <username> -n project-name (optional)`

### 3. How to assign sudoer cluster role to user.

`oc create clusterrolebinding <any_valid_name> --clusterrole=sudoer --user=<username>`

Example:

```
$ oc create clusterrolebinding bank-as-sudoer --clusterrole=sudoer --user=bank
clusterrolebinding.rbac.authorization.k8s.io/bank-as-sudoer created

$ oc get clusterrolebinding.rbac.authorization.k8s.io/bank-as-sudoer -o yaml

$ oc --as=system:admin whoami
system:admin

$ oc get secret -n openshift-config
Error from server (Forbidden): secrets is forbidden: User "bank" cannot list resource "secrets" in API group "" in the namespace "openshift-config"

$ oc --as=system:admin get secret -n openshift-config
NAME                                  TYPE                                  DATA   AGE
builder-dockercfg-2df5d               kubernetes.io/dockercfg               1      3d14h
builder-token-2g5pk                   kubernetes.io/service-account-token   4      3d14h
builder-token-8p2p7                   kubernetes.io/service-account-token   4      3d14h
default-dockercfg-nbg7w               kubernetes.io/dockercfg               1      3d14h
default-token-drwtv                   kubernetes.io/service-account-token   4      3d14h
default-token-jfx72                   kubernetes.io/service-account-token   4      3d14h
deployer-dockercfg-km5n4              kubernetes.io/dockercfg               1      3d14h
deployer-token-pnx8s                  kubernetes.io/service-account-token   4      3d14h
deployer-token-vm7p7                  kubernetes.io/service-account-token   4      3d14h
etcd-client                           SecretTypeTLS                         2      3d14h
etcd-metric-client                    SecretTypeTLS                         2      3d14h
etcd-metric-signer                    SecretTypeTLS                         2      3d14h
etcd-signer                           SecretTypeTLS                         2      3d14h
htpasswd                              Opaque                                1      3d10h
initial-service-account-private-key   Opaque                                1      3d14h
pull-secret                           kubernetes.io/dockerconfigjson        1      3d14h

```
### 4. How to remove self-provisioner role from authenticated user:

` oc adm policy remove-cluster-role-from-group self-provisioner system:authenticated:oauth`
 
 
### 5. How to assign project admin privilege to user "keith"

`oc adm policy add-role-to-user admin keith -n project-name`

### 6. How to assign read-only permission to user "keith"

`oc adm policy add-role-to-user view keith -n project-name`

### 7. How to assign full control over the project including rate limit

`oc adm policy add--role-to-user cluster-admin keith`


### 8. How to test which user can perform tasks.

`oc adm policy who-can delete user`

## Projects


### 1. How to create openshift project

```
oc new-project hello-openshift \
    --description="This is an example project" \
    --display-name="Hello OpenShift"
```
    
### 2. How to switch between project.

`oc project <projectname>`

### 3. How to delete project

`oc delete project <project_name>`

### 4. how to allow other user to work on my project

`oc policy add-role-to-group edit <username> -n project-name (optional)`


## Build
### 1. How to create build config from local git repository

`oc new-build .`

### 2. How to create a build config from remote git repository

`oc new-build https://github.com/sclorg/cakephp-ex`

### 3. How to start build from specified build config

`oc start-build python`

### 4. How to start build from previous build

`oc start-build --from-build=python-1`

## Deploy
### 1. How to deploy new application from Source code
### 2. How to deploy new application from Dockerfile
### 3. HOw to deploy new application from Docker Image

## Image & Image Stream & Image Stream Tag

Containers, images, and imagestreams are important concepts to understand when you set out to create and manage containerized software. An image holds a set of software that is ready to run, while a container is a running instance of a container image. An imagestream provides a way of storing different versions of the same basic image. Those different versions are represented by different tags on the same image name.

## Image Registry

## Resource Management
1. limit resource usage

## Upgrade
1. How to upgrade OpenShift Cluster
## Scale
1. scale application to meet increased demand

## Event & Alert & logs

1. HOw to monitor cluster status
2. How to monitor cluster event and alerts
3. How to view logs 
4. How to view log of failed/terminated pods.
5. 
## Kubernetes Resources
1. How to import Kubernetes resources


## Networking - Routes, Services, Ingress
1. How to create route (Expose a Service externally as a Route)

Example: Expose a Service

`$ oc expose service/parksmap-katacoda`

Example: Expose a Service and specify the host name

`$ oc expose service/parksmap-katacoda --hostname=www.my-host.com`


2. How to remove route
3. Create self signed certificate
4. Secure route using TLS certificate

## Rollout

## Cluster Scaling.



## Installation

## Troubleshooting 
### 0. get cluster version
> oc get clusterversion </p>
> NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS </p>
> version   4.4.8     True        False         3d13h   Cluster version is 4.4.8

`oc describe clusterversion`

### review cluster operators
`oc get clusteroperators`


### 1. debug pod
`oc logs pod/podname` </p>
`oc debug pod/podname`

### 2. debug node
`oc get nodes` </p>
`oc adm top nodes` </p>
`oc describe node my-node-name` </p>
`oc adm node-logs -u crio my-node-name` </p>
`oc adm node-logs -u kubelet my-node-name` </p>
`oc adm node-logs my-node-name` </p>

open shell prompt to node:

`oc debug node/my-node-name`

> $ oc debug node/ip-10-0-138-229.ap-southeast-1.compute.internal
> 
> Starting pod/ip-10-0-138-229ap-southeast-1computeinternal-debug ...
> To use host binaries, run `chroot /host`
> 
> chroot /host
> Pod IP: 10.0.138.229
> If you don't see a command prompt, try pressing enter.
> 
> sh-4.2# chroot /host </p>
> sh-4.4# cat /etc/*release*
> 
> NAME="Red Hat Enterprise Linux CoreOS"
> 
> VERSION="44.81.202006080130-0"
> 
> VERSION_ID="4.4"
> 
> OPENSHIFT_VERSION="4.4"
> 
> RHEL_VERSION="8.2"
> 
> PRETTY_NAME="Red Hat Enterprise Linux CoreOS 44.81.202006080130-0 (Ootpa)"
> 
> ID="rhcos"
> 

list container on nodes </P>
`crictl ps`

`systemctl status kubelet`

> $ oc adm top node
> NAME                                              CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
> ip-10-0-138-229.ap-southeast-1.compute.internal   330m         4%     2541Mi          8%
> ip-10-0-152-138.ap-southeast-1.compute.internal   509m         14%    3258Mi          22%
> ip-10-0-179-0.ap-southeast-1.compute.internal     421m         5%     3373Mi          11%
> ip-10-0-189-168.ap-southeast-1.compute.internal   508m         14%    3221Mi          22%
> ip-10-0-214-156.ap-southeast-1.compute.internal   626m         17%    3606Mi          24%
> thanachit@BankMBP ~/Projects/openshift-task/users (master)

> $ oc adm top pod
> NAME                      CPU(cores)   MEMORY(bytes)
> example-75778c488-9nz95   0m           1Mi
> example-75778c488-h7n9g   0m           1Mi
> example-75778c488-pd6rw   0m           2Mi
> my-simple-web-9-68xr7     0m           28Mi
> my-simple-web-9-7n6bp     0m           20Mi


### 3. oc with debug

`oc --loglevel 7 get pod`

## Persistent Storage 

